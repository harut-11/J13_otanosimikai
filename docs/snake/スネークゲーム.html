<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>„Çπ„Éç„Éº„ÇØ„Ç≤„Éº„É†</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #2c3e50;
            color: white;
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
        }
        h1 { margin: 0 0 10px 0; color: #2ecc71; letter-spacing: 2px; }
        
        .status-container {
            display: flex;
            gap: 20px;
            font-size: 1.1rem;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.4);
            padding: 10px 25px;
            border-radius: 10px;
            align-items: center;
            border: 1px solid #34495e;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #bdc3c7;
            margin-left: 10px;
        }

        .game-main {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .rank-list {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            font-weight: bold;
        }
        .rank-item {
            padding: 12px 15px;
            border-radius: 5px;
            background: rgba(255,255,255,0.05);
            transition: 0.4s;
            color: #7f8c8d;
            width: 240px;
            text-align: left;
            white-space: nowrap;
            font-size: 0.9rem;
            border-left: 4px solid transparent;
        }
        .active-rank {
            background: rgba(241, 196, 15, 0.2) !important;
            color: #f1c40f !important;
            border-left: 4px solid #f1c40f;
            box-shadow: -5px 0 15px rgba(241, 196, 15, 0.3);
            transform: scale(1.05);
        }

        canvas {
            border: 5px solid #ecf0f1;
            box-shadow: 0 0 30px rgba(0,0,0,0.7);
            background-color: #000;
        }

        .speed-msg { color: #f1c40f; font-weight: bold; height: 24px; margin-top: 10px; font-size: 1.2rem; }
        
        #restart-hint {
            margin-top: 15px;
            font-size: 1.1rem;
            color: #ff7675;
            visibility: hidden;
            font-weight: bold;
            animation: blink 1s infinite;
        }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <h1>„Çπ„Éç„Éº„ÇØ„Ç≤„Éº„É†</h1>

    <audio id="bgm" loop><source src="ÈõªÊ∞óË°ó„ÅÆÊÇ™È≠î.mp3" type="audio/mpeg"></audio>
    <audio id="eatSound"><source src="È£ü„ÅπÁâ©Èü≥.mp3" type="audio/mpeg"></audio>

    <div class="status-container">
        <div>„Çπ„Ç≥„Ç¢: <span id="score">0</span></div>
        <div style="color: #f39c12;">„Éè„Ç§„Çπ„Ç≥„Ç¢: <span id="highScore">0</span></div>
        <div>„Çπ„Éî„Éº„Éâ: <span id="speedDisplay">1.0</span>x</div>
        
        <div class="volume-control">
            <span>Èü≥Èáèüîä</span>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.5">
        </div>
    </div>

    <div class="game-main">
        <div class="rank-list" id="rankContainer">
            <div class="rank-item" id="rank-S">„É©„É≥„ÇØ SÔºö‰ºùË™¨„ÅÆ„Éò„Éì (200+)</div>
            <div class="rank-item" id="rank-A">„É©„É≥„ÇØ AÔºö„Çπ„Éç„Éº„ÇØ„Éû„Çπ„Çø„Éº (160-190)</div>
            <div class="rank-item" id="rank-B">„É©„É≥„ÇØ BÔºö‰∏≠Á¥ö„Çπ„Éç„Éº„ÇØ (110-150)</div>
            <div class="rank-item" id="rank-C">„É©„É≥„ÇØ CÔºöÂàùÁ¥ö„Çπ„Éç„Éº„ÇØ (50-100)</div>
            <div class="rank-item" id="rank-D">„É©„É≥„ÇØ DÔºöË¶ãÁøí„ÅÑ„Çπ„Éç„Éº„ÇØ (0-40)</div>
        </div>

        <canvas id="gameCanvas" width="400" height="400"></canvas>
    </div>

    <div id="msg" class="speed-msg"></div>
    <div id="restart-hint">GAME OVER - ENTER„Ç≠„Éº„Åß„É™„Éà„É©„Ç§</div>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const scoreElement = document.getElementById("score");
        const highScoreElement = document.getElementById("highScore");
        const speedDisplay = document.getElementById("speedDisplay");
        const msgElement = document.getElementById("msg");
        const restartHint = document.getElementById("restart-hint");
        const volumeSlider = document.getElementById("volumeSlider");
        
        const bgm = document.getElementById("bgm");
        const eatSound = document.getElementById("eatSound");

        // Èü≥ÈáèÂàùÊúüË®≠ÂÆö
        bgm.volume = volumeSlider.value;
        eatSound.volume = volumeSlider.value;

        volumeSlider.addEventListener("input", (e) => {
            const vol = e.target.value;
            bgm.volume = vol;
            eatSound.volume = vol;
        });

        const gridSize = 20;
        const tileCount = canvas.width / gridSize;

        let score = 0;
        let highScore = localStorage.getItem("snakeHighScore") || 0;
        highScoreElement.innerHTML = highScore;

        let dx = 0, dy = 0;
        let baseSpeed = 100, currentSpeed = baseSpeed;
        let snake = [{x: 10, y: 10}, {x: 10, y: 11}, {x: 10, y: 12}];
        let foodX = 5, foodY = 5;
        let isGameOver = false;
        let isMusicPlaying = false;

        document.addEventListener("keydown", handleKeydown);

        function main() {
            if (isGameOver) {
                bgm.pause();
                return;
            }

            if (didGameEnd()) {
                isGameOver = true;
                highlightRank(score);
                updateHighScore();
                restartHint.style.visibility = "visible";
                return;
            }

            updateSpeed();

            setTimeout(function onTick() {
                clearCanvas();
                drawFood();
                advanceSnake();
                drawSnake();
                main();
            }, currentSpeed);
        }

        function handleKeydown(event) {
            if (!isMusicPlaying && [37, 38, 39, 40].includes(event.keyCode)) {
                bgm.play().catch(e => console.log("Audio playback failed"));
                isMusicPlaying = true;
            }

            const keyPressed = event.keyCode;
            if (isGameOver && keyPressed === 13) {
                bgm.currentTime = 0;
                bgm.play();
                resetGame();
                return;
            }
            
            const LEFT = 37, UP = 38, RIGHT = 39, DOWN = 40;
            if (keyPressed === LEFT && dx !== 1) { dx = -1; dy = 0; }
            if (keyPressed === UP && dy !== 1) { dx = 0; dy = -1; }
            if (keyPressed === RIGHT && dx !== -1) { dx = 1; dy = 0; }
            if (keyPressed === DOWN && dy !== -1) { dx = 0; dy = 1; }
        }

        function advanceSnake() {
            const head = {x: snake[0].x + dx, y: snake[0].y + dy};
            if (dx === 0 && dy === 0) return;
            snake.unshift(head);
            
            if (snake[0].x === foodX && snake[0].y === foodY) {
                score += 10;
                scoreElement.innerHTML = score;
                eatSound.pause();
                eatSound.currentTime = 0;
                eatSound.play().catch(e => {});
                createFood();
            } else { 
                snake.pop(); 
            }
        }

        function highlightRank(s) {
            document.querySelectorAll('.rank-item').forEach(el => el.classList.remove('active-rank'));
            let id = (s >= 200) ? "rank-S" : (s >= 160) ? "rank-A" : (s >= 110) ? "rank-B" : (s >= 50) ? "rank-C" : "rank-D";
            document.getElementById(id).classList.add('active-rank');
        }

        function updateHighScore() {
            if (score > highScore) {
                highScore = score;
                localStorage.setItem("snakeHighScore", highScore);
                highScoreElement.innerHTML = highScore;
            }
        }

        function resetGame() {
            score = 0; dx = 0; dy = 0; isGameOver = false;
            currentSpeed = baseSpeed;
            snake = [{x: 10, y: 10}, {x: 10, y: 11}, {x: 10, y: 12}];
            scoreElement.innerHTML = score;
            restartHint.style.visibility = "hidden";
            msgElement.innerHTML = "";
            document.querySelectorAll('.rank-item').forEach(el => el.classList.remove('active-rank'));
            createFood();
            main();
        }

        function updateSpeed() {
            let multiplier = (score >= 200) ? 2.0 : (score >= 150) ? 1.5 : (score >= 110) ? 1.1 : 1.0;
            if (multiplier === 2.0) msgElement.innerHTML = "ÊúÄÈ´òÈÄüÂ∫¶ÔºÅÔºÅ";
            else if (multiplier === 1.5) msgElement.innerHTML = "„Çπ„Éî„Éº„Éâ„Ç¢„ÉÉ„ÉóÔºÅÔºÅ";
            else if (multiplier === 1.1) msgElement.innerHTML = "Âä†ÈÄü‰∏≠...";
            else msgElement.innerHTML = "";
            
            currentSpeed = baseSpeed / multiplier;
            speedDisplay.innerHTML = multiplier.toFixed(1);
        }

        function clearCanvas() { ctx.fillStyle = "black"; ctx.fillRect(0, 0, canvas.width, canvas.height); }
        function drawSnake() {
            snake.forEach((part, index) => {
                ctx.fillStyle = (index === 0) ? "#2ecc71" : "#27ae60";
                ctx.fillRect(part.x * gridSize, part.y * gridSize, gridSize - 2, gridSize - 2);
            });
        }
        function didGameEnd() {
            if (dx === 0 && dy === 0) return false;
            const hitWall = snake[0].x < 0 || snake[0].x > tileCount - 1 || snake[0].y < 0 || snake[0].y > tileCount - 1;
            let hitSelf = false;
            for (let i = 4; i < snake.length; i++) { if (snake[i].x === snake[0].x && snake[i].y === snake[0].y) hitSelf = true; }
            return hitWall || hitSelf;
        }
        function createFood() {
            foodX = Math.floor(Math.random() * tileCount);
            foodY = Math.floor(Math.random() * tileCount);
        }
        function drawFood() {
            ctx.fillStyle = "#e74c3c";
            ctx.fillRect(foodX * gridSize, foodY * gridSize, gridSize - 2, gridSize - 2);
        }

        createFood();
        main();
    </script>
</body>
</html>